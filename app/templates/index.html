{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <div class="text-center mb-5">
        <h1 class="display-5 fw-bold text-success">üçΩÔ∏è Weekly Meal Planner</h1>
        <p class="lead">Recipes can be selected to consider time, calories, variety, ingredient synergy, and recency.</p>
    </div>

    <div class="container py-4">
        {% if has_active_plan %}
        <div class="alert alert-info d-flex justify-content-between align-items-center shadow-sm mb-4">
            <div class="d-flex align-items-center">
                <i class="bi bi-info-circle-fill fs-4 me-3"></i>
                <div>
                    <strong class="d-block">Plan in Progress</strong>
                    <span class="small">You have a selection ready to cook.</span>
                </div>
            </div>
            <a href="{{ url_for('main.current_plan') }}" class="btn btn-info btn-sm fw-bold px-3">
                Resume <i class="bi bi-arrow-right ms-1"></i>
            </a>
        </div>
        {% endif %}
    </div>

    <div class="card shadow-sm mb-5 border-0 bg-light">
        <div class="card-body">
            <h5 class="card-title mb-3">‚öôÔ∏è Preferences</h5>
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label small fw-bold">Prefered Max Prep Time (Mins)</label>
                    <input type="number" name="global_max_time" class="form-control" placeholder="e.g. 40">
                </div>
                <div class="col-md-6">
                    <label class="form-label small fw-bold">Prefered Max Calories (Mins)</label>
                    <input type="number" name="global_max_cal" class="form-control" placeholder="e.g. 800">
                </div>
            </div>
        </div>
    </div>
    {% if synergy %}
    <div class="alert alert-success border-success shadow-sm mb-4 animate__animated animate__fadeIn">
        <div class="d-flex align-items-center">
            <div class="fs-2 me-3">‚ôªÔ∏è</div>
            <div>
                <h5 class="alert-heading mb-1">Smart Synergy Found!</h5>
                <p class="mb-0">You're efficiently using these ingredients across multiple meals: 
                    <strong>{{ synergy|join(', ') }}</strong>.
                </p>
            </div>
        </div>
    </div>
    {% elif slots|select|list|length > 1 %}
    <div class="alert alert-light border shadow-sm mb-4 text-center">
        <p class="mb-0 text-muted italic">üí° Try picking a different category to see if we can find more ingredient overlaps!</p>
    </div>
    {% endif %}

    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        {% for i in range(6) %}
        <div class="col">
            <div class="card h-100 shadow-sm border-2 {% if slots[i] %}border-success{% else %}border-dashed{% endif %}">
                <div class="card-header bg-transparent border-0 pt-3">
                    <span class="badge bg-secondary">MEAL {{ i + 1 }}</span>
                </div>
                
                <div class="card-body d-flex flex-column align-items-center justify-content-center text-center">
                    {% if slots[i] %}
                        <div class="position-absolute top-0 end-0 p-2 d-flex gap-1" style="z-index: 5;">
                            <form action="{{ url_for('main.toggle_status', recipe_id=slots[i].id, status_type='favourite') }}" method="POST">
                                <button type="submit" class="btn btn-light btn-sm rounded-circle shadow-sm border p-0" style="width: 28px; height: 28px; line-height: 28px;">
                                    <i class="bi {{ 'bi-heart-fill text-danger' if slots[i].is_favourite else 'bi-heart' }}"></i>
                                </button>
                            </form>
                            <form action="{{ url_for('main.toggle_status', recipe_id=slots[i].id, status_type='dislike') }}" method="POST">
                                <button type="submit" class="btn btn-light btn-sm rounded-circle shadow-sm border p-0" style="width: 28px; height: 28px; line-height: 28px;">
                                    <i class="bi {{ 'bi-hand-thumbs-down-fill text-dark' if slots[i].is_disliked else 'bi-hand-thumbs-down' }}"></i>
                                </button>
                            </form>
                        </div>


                <div class="card-body d-flex flex-column align-items-center justify-content-center text-center">
                    {% if slots[i].image_url %}
                        <img src="{{ slots[i].image_url }}" class="img-fluid rounded mb-3" style="height: 140px; width: 100%; object-fit: cover;">
                    {% endif %}
                    <div class="mb-3">
                        {% set cat = slots[i].category %}
                        <span class="badge rounded-pill 
                            {{ 'bg-warning text-dark' if cat == 'Chicken' }}
                            {{ 'bg-danger' if cat == 'Beef' }}
                            {{ 'bg-secondary' if cat == 'Pork' }}
                            {{ 'bg-info text-dark' if cat == 'Fish' }}
                            {{ 'bg-success' if cat == 'Vegetarian' }}
                            {{ 'bg-dark' if cat == 'Other' }}">
                            {{ cat }}
                        </span>
                        <i class="bi bi-pencil-square ms-1 text-muted small" 
                        style="cursor: pointer;" 
                        onclick="openRecipeReclassify('{{ slots[i].id }}', '{{ slots[i].name }}')"></i>
                    </div>
                    <h6 class="fw-bold mb-1">{{ slots[i].name }}</h6>
                    {% if slots[i].source_url %}
                    <a href="{{ slots[i].source_url }}" target="_blank" class="btn btn-link btn-sm p-0 mb-3 text-decoration-none">
                        View on Gousto <i class="bi bi-box-arrow-up-right"></i>
                    </a>
                    {% endif %}
                    
                    <form action="{{ url_for('main.clear_slot', slot_index=i) }}" method="POST" class="w-100 mt-auto">
                        <button type="submit" class="btn btn-sm btn-outline-danger w-100">üîÑ Change Meal</button>
                    </form>
                </div>

                    {% else %}
                        <p class="text-muted small mb-2">How would you like to pick a meal?</p>
                            
                        <div class="d-flex gap-2 justify-content-center mb-3">
                            <button type="button" class="btn btn-sm btn-primary search-trigger" 
                                    data-slot="{{ i }}" 
                                    data-fav="false">
                                <i class="bi bi-search"></i> Search
                            </button>
                            <button type="button" class="btn btn-sm btn-warning search-trigger" 
                                    data-slot="{{ i }}" 
                                    data-fav="true">
                                <i class="bi bi-star-fill"></i> Favs
                            </button>
                        </div>
                        <div class="d-flex flex-wrap gap-1 justify-content-center">
                            {% for cat in ['Chicken', 'Beef', 'Pork', 'Fish', 'Vegetarian', 'All'] %}
                            <form action="{{ url_for('main.randomise_slot', slot_index=i) }}" method="POST">
                                <input type="hidden" name="category" value="{{ cat }}">
                                <input type="hidden" name="max_time" class="pref-time-mirror">
                                <input type="hidden" name="max_cal" class="pref-cal-mirror">
                                <button type="submit" class="btn btn-xs btn-outline-secondary architect-btn" style="font-size: 0.75rem;">
                                    {{ cat }}
                                </button>
                            </form>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="text-center mt-5 py-4">
        <button type="button" 
                class="btn btn-outline-primary btn-lg px-4 me-2" 
                data-bs-toggle="modal" 
                data-bs-target="#previewModal"
                id="previewBtn">
            <i class="bi bi-cart3 me-2"></i>Preview List
        </button>
    </div>

    <div class="text-center mt-5 py-4">
        <button type="button" 
                id="finaliseBtn" 
                class="btn btn-success btn-lg px-5 shadow-sm">
            <i class="bi bi-calendar-check me-2"></i>Finalise Weekly Plan
        </button>
    </div>
</div>

<style>
    .border-dashed { border-style: dashed !important; border-width: 2px; background-color: #fdfdfd; min-height: 300px; }
    .architect-btn { min-width: 85px; }
    .recipe-card img { transition: transform 0.3s ease; }
    .recipe-card:hover img { transform: scale(1.02); }
</style>

<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">‚úÖ Category updated successfully!</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<div class="modal fade" id="recipeSearchModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Find a Recipe</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="recipeQuery" class="form-control mb-3" placeholder="Start typing a recipe name...">
                <div id="searchResults" class="list-group">
                    </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="recipeReclassifyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 pb-0">
                <h6 class="modal-title fw-bold" id="recTitle">Change Category</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="reclassifyRecipeForm" method="POST">
                    <div class="d-grid gap-2">
                        {% for cat in ['Chicken', 'Beef', 'Pork', 'Fish', 'Vegetarian', 'Other'] %}
                        <button type="submit" name="category" value="{{ cat }}" class="btn btn-outline-dark btn-sm text-start">
                            {{ cat }}
                        </button>
                        {% endfor %}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% include "_shopping_list_modal.html" %}
{% endblock %}