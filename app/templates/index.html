{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <div class="text-center mb-5">
        <h1 class="display-5 fw-bold text-success">üçΩÔ∏è Weekly Meal Planner</h1>
        <p class="lead text-muted">Optimise for time, calories, variety, and ingredient synergy.</p>
    </div>

    {% if has_active_plan %}
    <div class="alert alert-info d-flex justify-content-between align-items-center shadow-sm mb-4 border-0">
        <div class="d-flex align-items-center">
            <i class="bi bi-info-circle-fill fs-4 me-3"></i>
            <div>
                <strong class="d-block">Plan in Progress</strong>
                <span class="small">You have a selection ready to cook.</span>
            </div>
        </div>
        <a href="{{ url_for('main.current_plan') }}" class="btn btn-info btn-sm fw-bold px-3">
            Resume <i class="bi bi-arrow-right ms-1"></i>
        </a>
    </div>
    {% endif %}

    <div class="card shadow-sm mb-4 border-0 bg-white">
        <div class="card-body py-3">
            <div class="row g-3 align-items-center">
                <div class="col-auto">
                    <span class="fw-bold text-dark"><i class="bi bi-sliders me-2"></i>Preferences:</span>
                </div>
                <div class="col">
                    <input type="number" name="global_max_time" class="form-control form-control-sm" placeholder="Max Prep Time (mins)">
                </div>
                <div class="col">
                    <input type="number" name="global_max_cal" class="form-control form-control-sm" placeholder="Max Calories">
                </div>
            </div>
        </div>
    </div>

    {% if synergy %}
    <div class="alert alert-success border-0 shadow-sm mb-4 animate__animated animate__fadeIn" style="background: linear-gradient(to right, #d4edda, #ffffff);">
        <div class="d-flex align-items-center">
            <div class="fs-2 me-3">‚ôªÔ∏è</div>
            <div>
                <h6 class="fw-bold mb-1 text-success">Smart Synergy Found!</h6>
                <p class="mb-0 small text-dark">Efficiently using: <strong>{{ synergy|join(', ') }}</strong>.</p>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        {% for i in range(6) %}
        <div class="col">
            <div class="card h-100 shadow-sm border-2 recipe-card {% if slots[i] %}border-success{% else %}border-dashed{% endif %}">
                
                {% if slots[i] %}
                    <div class="position-absolute top-0 end-0 p-2 d-flex gap-1" style="z-index: 5;">
                        <form action="{{ url_for('main.toggle_status', recipe_id=slots[i].id, status_type='favourite') }}" method="POST">
                            <button type="submit" class="btn btn-white btn-sm rounded-circle shadow-sm border p-0 btn-action">
                                <i class="bi {{ 'bi-heart-fill text-danger' if slots[i].is_favourite else 'bi-heart' }}"></i>
                            </button>
                        </form>
                        <form action="{{ url_for('main.toggle_status', recipe_id=slots[i].id, status_type='dislike') }}" method="POST">
                            <button type="submit" class="btn btn-white btn-sm rounded-circle shadow-sm border p-0 btn-action">
                                <i class="bi {{ 'bi-hand-thumbs-down-fill text-dark' if slots[i].is_disliked else 'bi-hand-thumbs-down' }}"></i>
                            </button>
                        </form>
                    </div>

                    <div class="card-body d-flex flex-column text-center">
                        <div class="text-start mb-2">
                            <span class="badge bg-light text-dark border">MEAL {{ i + 1 }}</span>
                        </div>

                        {% if slots[i].image_url %}
                            <img src="{{ slots[i].image_url }}" class="img-fluid rounded mb-3 shadow-sm" style="height: 160px; width: 100%; object-fit: cover;">
                        {% endif %}

                        <div class="mb-2">
                            {% set cat = slots[i].category %}
                            <span class="badge rounded-pill 
                                {{ 'bg-warning text-dark' if cat == 'Chicken' }}
                                {{ 'bg-danger text-white' if cat == 'Beef' }}
                                {{ 'bg-secondary' if cat == 'Pork' }}
                                {{ 'bg-info text-dark' if cat == 'Fish' }}
                                {{ 'bg-success text-white' if cat == 'Vegetarian' }}
                                {{ 'bg-dark' if cat == 'Other' }}">
                                {{ cat }}
                            </span>
                            <i class="bi bi-pencil-square ms-1 text-muted small" style="cursor: pointer;" onclick="openRecipeReclassify('{{ slots[i].id }}', '{{ slots[i].name }}')"></i>
                        </div>

                        <h6 class="fw-bold mb-1 text-truncate" title="{{ slots[i].name }}">{{ slots[i].name }}</h6>
                        
                        {% if slots[i].source_url %}
                        <a href="{{ slots[i].source_url }}" target="_blank" class="btn btn-link btn-sm p-0 mb-3 text-decoration-none text-muted">
                            <small>View Details <i class="bi bi-box-arrow-up-right"></i></small>
                        </a>
                        {% endif %}
                        
                        <form action="{{ url_for('main.clear_slot', slot_index=i) }}" method="POST" class="w-100 mt-auto">
                            <button type="submit" class="btn btn-sm btn-outline-danger w-100 border-0">
                                <i class="bi bi-arrow-repeat me-1"></i>Change
                            </button>
                        </form>
                    </div>

                {% else %}
                    <div class="card-body d-flex flex-column align-items-center justify-content-center text-center p-4">
                        <div class="mb-3 text-muted">
                            <i class="bi bi-plus-circle-dotted display-4"></i>
                            <p class="fw-bold mt-2 mb-1">Meal {{ i + 1 }}</p>
                        </div>
                        
                        <div class="d-flex gap-2 mb-3">
                            <button class="btn btn-sm btn-primary search-trigger px-3" data-slot="{{ i }}" data-fav="false">
                                <i class="bi bi-search me-1"></i> Search
                            </button>
                            <button class="btn btn-sm btn-warning search-trigger px-3" data-slot="{{ i }}" data-fav="true">
                                <i class="bi bi-star-fill me-1"></i> Favs
                            </button>
                        </div>

                        <div class="row g-2 justify-content-center">
                            {% for cat in ['Chicken', 'Beef', 'Pork', 'Fish', 'Vegetarian', 'All'] %}
                            <div class="col-4">
                                <form action="{{ url_for('main.randomise_slot', slot_index=i) }}" method="POST">
                                    <input type="hidden" name="category" value="{{ cat }}">
                                    <button type="submit" class="btn btn-outline-secondary w-100 py-2 architect-btn shadow-sm" style="font-size: 0.85rem;">
                                        {{ cat }}
                                    </button>
                                </form>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="d-flex justify-content-center gap-3 mt-5 pb-5">
        <button type="button" class="btn btn-outline-secondary btn-lg px-4" data-bs-toggle="modal" data-bs-target="#previewModal" id="previewBtn">
            <i class="bi bi-list-check me-2"></i>Review Shopping List
        </button>
        <button type="button" id="finaliseBtn" class="btn btn-success btn-lg px-5 shadow">
            <i class="bi bi-calendar-check me-2"></i>Finalise Plan
        </button>
    </div>
</div>

<style>
    .border-dashed { 
        border-style: dashed !important; 
        border-width: 2px; 
        background-color: #f8f9fa; 
        min-height: 420px; /* Increased height to accommodate bigger buttons */
        transition: all 0.2s; 
    }
    .border-dashed:hover { 
        background-color: #f1f3f5; 
        border-color: #adb5bd !important; 
    }
    .architect-btn { 
        transition: transform 0.1s; 
    }
    .architect-btn:active { 
        transform: scale(0.95); 
    }
    .recipe-card { 
        transition: transform 0.2s, box-shadow 0.2s; 
    }
    .recipe-card:hover { 
        transform: translateY(-5px); 
        box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important; 
    }
</style>

<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">‚úÖ Category updated successfully!</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<div class="modal fade" id="recipeSearchModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Find a Recipe</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="recipeQuery" class="form-control mb-3" placeholder="Start typing a recipe name...">
                <div id="searchResults" class="list-group">
                    </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="recipeReclassifyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 pb-0">
                <h6 class="modal-title fw-bold" id="recTitle">Change Category</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="reclassifyRecipeForm" method="POST">
                    <div class="d-grid gap-2">
                        {% for cat in ['Chicken', 'Beef', 'Pork', 'Fish', 'Vegetarian', 'Other'] %}
                        <button type="submit" name="category" value="{{ cat }}" class="btn btn-outline-dark btn-sm text-start">
                            {{ cat }}
                        </button>
                        {% endfor %}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% include "_shopping_list_modal.html" %}
{% endblock %}